<!doctype html>
<head>
<style>
.error {
  background-color: #ffaaaa;
}
.pre {
    white-space: pre;
    font-family: monospace;
    display: block;
    unicode-bidi: embed
}
</style>
</head>
<body>
<input placeholder="Username" type="text" id="username" autofocus required />
<button id="sign_up">Sign up</button>
<button id="sign_in">Sign in</button>
<div class="pre" id="log"></div>
<script type="text/javascript" src="base64.js"></script>
<script>
  // All code in this file is based on: https://webauthn.io/dist/js/webauthn.js

  function buffer_decode(value) {
    return Uint8Array.from(atob(value), c => c.charCodeAt(0));
  }

  function sign_up() {
    if (document.getElementById("username").value === "") {
      document.getElementById("log").innerHTML += "please enter a username\n";
      document.getElementById("username").focus();
      return;
    }
    fetch("/api/rpc/init_credential", {
      method: "POST",
      headers: {
        "Content-Type": "application/json;charset=utf-8"
      },
      body: JSON.stringify({
          "username" : document.getElementById("username").value
      })
    }).then(function(response) {
      response.json().then(function(make_credential_options) {
        // base64 values needs to be decoded to Uint8Arrays:
        make_credential_options.publicKey.challenge = buffer_decode(make_credential_options.publicKey.challenge);
        make_credential_options.publicKey.user.id = buffer_decode(make_credential_options.publicKey.user.id);
        if (make_credential_options.publicKey.excludeCredentials) {
          for (var i = 0; i < make_credential_options.publicKey.excludeCredentials.length; i++) {
            make_credential_options.publicKey.excludeCredentials[i].id = buffer_decode(make_credential_options.publicKey.excludeCredentials[i].id);
          }
        }
        navigator.credentials.create(make_credential_options).then(function (new_credential) {
          make_credential(new_credential, make_credential_options.publicKey.challenge);
        }).catch(function (err) {
          document.getElementById("log").innerHTML += "not ok navigator.credentials.create\n";
        });
      });
    }).catch((error) => {
      document.getElementById("log").innerHTML += "not ok init_credential\n";
    });
  }

  function make_credential(new_credential, challenge) {
    let attestation_object = new Uint8Array(new_credential.response.attestationObject);
    let client_data_json = new Uint8Array(new_credential.response.clientDataJSON);
    let raw_id = new Uint8Array(new_credential.rawId);
      fetch("/api/rpc/make_credential", {
        method: "POST",
        headers: {
          "Content-Type": "application/json;charset=utf-8"
        },
        body: JSON.stringify({
            "username" : document.getElementById("username").value,
            "challenge" : base64js.fromByteArray(challenge),
            "credential_raw_id" : base64js.fromByteArray(raw_id),
            "credential_type" : new_credential.type,
            "attestation_object" : base64js.fromByteArray(attestation_object),
            "client_data_json" : base64js.fromByteArray(client_data_json)
        })
      }).then(function(response) {
        response.json().then(function(status) {
          if (status) {
            document.getElementById("log").innerHTML += "ok make_credential\n";
          } else {
            document.getElementById("log").innerHTML += "not ok make_credential\n";
          }
        });
      });
    }

  function sign_in() {
    if (document.getElementById("username").value === "") {
      document.getElementById("log").innerHTML += "please enter a username\n";
      document.getElementById("username").focus();
      return;
    }
    fetch("/api/rpc/get_credentials", {
      method: "POST",
      headers: {
        "Content-Type": "application/json;charset=utf-8"
      },
      body: JSON.stringify({
          "username" : document.getElementById("username").value
      })
    }).then(function(response) {
      response.json().then(function (make_assertion_options) {
        if (make_assertion_options === null) {
          document.getElementById("log").innerHTML += "no credentials found for username\n";
          return;
        }
        make_assertion_options.publicKey.challenge = buffer_decode(make_assertion_options.publicKey.challenge);
        make_assertion_options.publicKey.allowCredentials.forEach(function (list_item) {
          list_item.id = buffer_decode(list_item.id)
        });
        navigator.credentials.get({
          publicKey: make_assertion_options.publicKey
        })
        .then(function (asserted_credential) {
          verify_assertion(asserted_credential);
        }).catch(function (err) {
          document.getElementById("log").innerHTML += "not ok navigator.credentials.get\n";
        });
      });
    }).catch(function (err) {
      document.getElementById("log").innerHTML += "not ok get_credentials\n";
    });
  }

  function verify_assertion(asserted_credential) {
    let authenticator_data = new Uint8Array(asserted_credential.response.authenticatorData);
    let client_data_json = new Uint8Array(asserted_credential.response.clientDataJSON);
    let credential_raw_id = new Uint8Array(asserted_credential.rawId);
    let signature = new Uint8Array(asserted_credential.response.signature);
    let user_handle = new Uint8Array(asserted_credential.response.userHandle);
    fetch("/api/rpc/verify_assertion", {
      method: "POST",
      headers: {
        "Content-Type": "application/json;charset=utf-8"
      },
      body: JSON.stringify({
        "credential_raw_id" : base64js.fromByteArray(credential_raw_id),
        "credential_type" : asserted_credential.type,
        "authenticator_data" : base64js.fromByteArray(authenticator_data),
        "client_data_json" : base64js.fromByteArray(client_data_json),
        "signature" : base64js.fromByteArray(signature),
        "user_handle" : base64js.fromByteArray(user_handle)
      })
    }).then(function(response) {
      response.json().then(function (status) {
        if (status) {
          document.getElementById("log").innerHTML += "ok verify_assertion\n";
        } else {
          document.getElementById("log").innerHTML += "not ok verify_assertion\n";
        }
      });
    });
  }

  document.getElementById("sign_up").addEventListener("click", sign_up);
  document.getElementById("sign_in").addEventListener("click", sign_in);
</script>
</body>
</html>